!function(e){function t(t){for(var r,a,o=t[0],h=t[1],c=t[2],u=0,d=[];u<o.length;u++)a=o[u],Object.prototype.hasOwnProperty.call(n,a)&&n[a]&&d.push(n[a][0]),n[a]=0;for(r in h)Object.prototype.hasOwnProperty.call(h,r)&&(e[r]=h[r]);for(l&&l(t);d.length;)d.shift()();return s.push.apply(s,c||[]),i()}function i(){for(var e,t=0;t<s.length;t++){for(var i=s[t],r=!0,o=1;o<i.length;o++){var h=i[o];0!==n[h]&&(r=!1)}r&&(s.splice(t--,1),e=a(a.s=i[0]))}return e}var r={},n={"web/wk_editor":0},s=[];function a(t){if(r[t])return r[t].exports;var i=r[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=r,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(i,r,function(t){return e[t]}.bind(null,r));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/js/cmodules/";var o=window.webpackJsonp=window.webpackJsonp||[],h=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var l=h;s.push([296,"bundles/common"]),i()}({296:function(e,t,i){e.exports=i("W16/")},"W16/":function(e,t,i){"use strict";i.r(t);i("HEwt"),i("rE2o"),i("ioFf"),i("Oyvg"),i("SRfc"),i("KKXr"),i("a1Th"),i("pIFo"),i("rGqo"),i("Btvt");var r=i("EasH"),n=i("FWc3"),s=i("RbYe");function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var i=[],r=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){n=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw s}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(i);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return o(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function h(e,t){this.cont=ge(e),this.imgWidth=400,extend(this,t),cur._wkeId=(cur._wkeId||0)+1,cur._wke=cur._wke||{},cur._wke[cur._wkeId]=this,cur.imagesInfo||(cur.imagesInfo={}),this.cont.setAttribute("contenteditable","true"),this.cont.setAttribute("spellcheck","true");var i="keydown mouseup keyup focus blur click copy cut paste beforepaste";addEvent(e,i,function(e){this.textEvent(e)}.bind(this)),cur.destroy.push((function(){removeEvent(e,i)})),this.plainMode=!1,this.inst="cur._wke["+cur._wkeId+"]";var r="";t.mode&&(this.mode=0,this.modeBtn=t.mode,r='<a id="wke_b_mode" class="wke_b wke_b_mode" wiki="mode" tooltip="'+t.mode[0]+'" onmousedown="'+this.inst+'.button(this, event);" onmouseover="'+this.inst+'.ttOver(this, true);"></a>');var n='<div id="wke_controls" class="wke_controls clear_fix"><div class="wke_loader"></div>'+(r+='<a id="wke_b_help" class="wke_b wke_b_help" wiki="help" tooltip="'+t.help[0]+'" onmousedown="'+this.inst+'.button(this, event);" onmouseover="'+this.inst+'.ttOver(this, true);"></a>')+'<div class="wke_panel clear_fix">';Object.keys(this.buttons).forEach(e=>{var t=this.buttons[e];n+='<a id="wke_b_'+e+'" class="wke_b wke_b_'+e+'" wiki="'+e+'" tooltip="'+t[0]+'" onmousedown="'+this.inst+'.button(this, event);" onmouseover="'+this.inst+'.ttOver(this);"></a>'}),n+="</div></div>",this.panelCont?this.panelCont.innerHTML=n:(this.panelCont=ce("div",{innerHTML:n,id:"wke_controls_cont"}),this.cont.parentNode.insertBefore(this.panelCont,this.source||this.cont)),addClass(this.panelCont,"wke_pcont"),this.panel=ge("wke_controls"),this.loader=geByClass1("wke_loader",this.panel),this.mode=1,this.state={},this.panelXY=getXY(this.panel,this.isLayer),t.source?this.textarea=this.source:this.textarea=this.cont.parentNode.insertBefore(ce("textarea"),this.cont),addClass(this.textarea,"wke_textarea"),autosizeSetup(this.textarea,{minHeight:t.minHeight||400}),addEvent(this.textarea,"keydown",function(e){this.textEvent(e)}.bind(this));var s=this.saveLastCursor.bind(this);addEvent(document,"mousedown",s),cur.destroy.push(()=>{removeEvent(this.textarea,"keydown"),removeEvent(document,"mousedown",s)}),this.pboxParams=t.pboxParams||{},this.checkBrowser(),setTimeout(function(){this.prepareCont(this.cont)}.bind(this))}extend(h.prototype,{textEvent:function(e){if("keydown"==e.type)switch(this.lastKey=e.keyCode,e.keyCode){case KEY.ENTER:if(this.onChangeHandler(),this.plainMode)break;if(this.state.pre){var t=document.createTextNode("\n");this.replaceSelected([t]);for(var i=t.nextSibling;i&&""==i.nodeValue;)i=i.nextSibling;return i||t.parentNode.insertBefore(document.createTextNode("\n"),t),this.setFocus(t),cancelEvent(e)}var r=this.getRange(),n=this.getState(r);if(n&&2==n[1]){var s=n[0],a=ce("br");if(!r.endOffset&&this.getText(s)){var o=this.prevNode(s);o&&"BR"!=o.tagName&&(3!=o.nodeType||o.data)&&s.parentNode.insertBefore(ce("br"),s),s.parentNode.insertBefore(a,s),this.setFocus(s,{toStart:!0})}else this.insertBreak(e,s);return cancelEvent(e)}break;case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:case KEY.ESC:case 17:case 16:case 18:case 91:break;case 66:(e.ctrlKey||e.metaKey)&&this.button(ge("wke_b_bold"),e);break;case 73:(e.ctrlKey||e.metaKey)&&this.button(ge("wke_b_italic"),e);break;default:this.onChangeHandler()}else if("mouseup"==e.type||"keyup"==e.type)this.checkEditPlace();else if("focus"==e.type)this.checkEditPlace();else if("blur"==e.type)this.switchMode(0);else if("click"==e.type){var h=e.target;if(this.isLink(h))return this.showUrlBox([h,3]),cancelEvent(e);var c=this.isPhoto(h);if(c)return this.showPhotoBox(c),cancelEvent(e);if(h==this.cont&&browser.opera)return this.setFocus(this.cont),cancelEvent(e)}else if("cut"!=e.type&&"copy"!=e.type||this.plainMode)"beforepaste"!==e.type&&"paste"!==e.type||this.plainMode||this.filterPastedContent(e);else{var l=geByTag("img",this.cont);l=Array.prototype.slice.apply(l),Object.keys(l).forEach(e=>{var t=l[e].parentNode;t&&"A"==t.tagName&&(cur.imagesInfo[l[e].src]=[t.getAttribute("onclick"),t.getAttribute("wiki"),t.getAttribute("href")])})}},filterPastedContent:function(e){Object(s.clipboardProcessPaste)(e).then(e=>{var t=a(e,2),i=t[0],r=t[1];i.length>3e5&&(i=i.substr(0,3e5)),i&&(i=(i=i.replace(/<\s*([^\t\n\f \/>"'=]+)([^\>]*?(?:(['"]).*?\3[^\>]*?|[^\>])*?)>(?:.*?<\s*\/\s*\1[^\>]*?(?:(['"]).*?\3[^\>]*?|[^\>])*?>)?/gi,(e,t)=>~["style","meta","link","script","embed","object","applet"].indexOf(t.toLowerCase())?"":e)).replace(/<\s*([^\t\n\f \/>"'=]+)([^\>]*?(?:(['"]).*?\3[^\>]*?|[^\>])*?)>/g,(e,t,i)=>`<${t}${i=i?(i=i.replace(/\bon\w+\s*=\s*(?:(["']).*?\1|[^\s\/]+)/gi,"")).replace(/\bstyle\s*=\s*((["']).*?\2|[^\s\/]+)/gi,(e,t)=>"style="+t.replace(/(?:-webkit-)?position\s*:\s*(sticky|absolute|fixed);?/gi,"")):""}>`)),r(i);var n=geByTag("img",this.cont);n=[].slice.apply(n),Object.keys(n).forEach(e=>{var t=n[e].parentNode;if("A"!=t.tagName||!attr(t,"wiki")){var i=cur.imagesInfo[n[e].src];if("A"!=t.tagName){var r=getSize(n[e]);if(!r[0])return;var s=ce("a",{innerHTML:`<img width="${r[0]}" height="${r[1]}" src="${n[e].src}" />`,contentEditable:"false",className:"wk_photo"});t.replaceChild(s,n[e]),t=s}attr(t,"onclick",i[0]),attr(t,"wiki",i[1]),attr(t,"href",i[2])}})}).catch(()=>{})},insertBreak:function(e,t){var i=ce("div",{innerHTML:"<br/>"});return t?t.nextSibling?t.parentNode.insertBefore(i,t.nextSibling):t.parentNode.appendChild(i):this.cont.appendChild(i),this.setFocus(i,{toStart:!0}),cancelEvent(e)},showBox:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){this.plainMode?cur.wkBoxRange=this.plainGetSel():cur.wkBoxRange=this.getRange();var e=showBox.apply(window,arguments);return!!e&&(e.setOptions({onHide:function(){cur.wkBoxRange&&this.setSelectionRange(cur.wkBoxRange)}.bind(this)}),e)})),checkFocus:function(){if(!browser.chrome)return!1;var e=this.getSel();if(e&&"None"!=e.type){var t=e.focusNode;if(t!=this.cont)for(;t;){if(t==this.cont)return!1;t=t.parentNode}}this.setFocus(this.cont)},toggleEditable:function(e){var t=geByClass("wk_photo",this.cont);t.push.apply(t,geByClass("wk_photo_no_padding",this.cont)),Object.keys(t).forEach(i=>{t[i].setAttribute("contenteditable",e?"false":"true")})},button:function(e,t){if(hasClass(e,"wke_b_disabled"))return cancelEvent(t);var i=e.getAttribute("wiki"),r=this.buttons[i],n=document;switch(this.plainMode||this.checkFocus(),i){case"bold":this.plainMode?this.plainInsert("'''","'''"):(n.execCommand("bold",!1,null),this.toggleState(i));break;case"italic":this.plainMode?this.plainInsert("''","''"):(n.execCommand("italic",!1,null),this.toggleState(i));break;case"image":var s=extend({act:"choose_photo",al_wiki_editor:1,is_blog_editor:-1!=location.href.indexOf("/blog")?1:0,to_id:cur.oid,scrollbar_width:window.sbWidth()},this.pboxParams);this.pbox=this.showBox("al_photos.php",s,{stat:["page.css","page.js"],cache:1}),window.editorChoosePhoto=this.insertPhoto.bind(this);break;case"video":this.vbox=this.showBox("al_video.php",{act:"a_choose_video_box",al_wiki_editor:1,from:"article",to_id:cur.oid,scrollbar_width:window.sbWidth()},{stat:["page.css","page.js"],cache:1}),window.editorChooseVideo=this.insertVideo.bind(this);break;case"audio":this.abox=this.showBox("audio.php",{act:"a_choose_audio_box",al_wiki_editor:1,to_id:cur.oid,scrollbar_width:window.sbWidth(),options:JSON.stringify({wiki:1})},{stat:["page.css","page.js"],cache:1}),window.editorChooseAudio=this.insertAudio.bind(this);break;case"left":this.plainMode?this.plainInsert("<left>","</left>"):(this.toggleEditable(!1),n.execCommand("justifyLeft",!1,!0),this.toggleEditable(!0),this.toggleState(i));break;case"center":this.plainMode?this.plainInsert("<center>","</center>"):(this.toggleEditable(!1),n.execCommand("justifyCenter",!1,!0),this.toggleEditable(!0),this.toggleState(i));break;case"right":this.plainMode?this.plainInsert("<right>","</right>"):(this.toggleEditable(!1),n.execCommand("justifyRight",!1,!0),this.toggleEditable(!0),this.toggleState(i));break;case"h1":this.plainMode?this.plainInsert("== "," ==",{newline:1}):this.wrapHeader("wk_header",r);break;case"h2":this.plainMode?this.plainInsert("=== "," ===",{newline:1}):this.wrapHeader("wk_sub_header",r);break;case"h3":this.plainMode?this.plainInsert("==== "," ====",{newline:1}):this.wrapHeader("wk_sub_sub_header",r);break;case"url":var a=this.getState(this.getRange());this.showUrlBox(a,!0);break;case"list":this.plainMode?this.plainInsert("* ","",{newline:1}):this.wrapList("ul",r);break;case"blockquote":this.plainMode?this.plainInsert("<blockquote>","</blockquote>",{newline:1}):this.wrapEl("blockquote",r,"<div>","</div>");break;case"mode":this.togglePlainMode(),this.toggleState(i);break;case"help":showBox("al_pages.php",{act:"markup_help"},{stat:["pages.css"]})}return"mode"!=i&&this.onChangeHandler(),cancelEvent(t)},checkBrowser:function(){var e=intval(browser.version),t=!1;browser.chrome&&e>11&&(t=1),browser.mozilla&&e>=4&&(t=1),browser.opera&&e>10&&(t=1),browser.safari&&e>4&&(t=1),browser.msie&&e>=9&&(t=1);var i=ge("wke_b_mode");t&&!this.plain?(show(this.cont),hide(this.textarea),this.setPlainMode(!1),this.modeBtn&&this.ttUpdate(i,this.modeBtn[0])):(hide(this.cont),show(this.textarea),this.setPlainMode(!0),this.modeBtn&&this.ttUpdate(i,this.modeBtn[1]),t||hide(i)),this.onPlainToggle&&this.onPlainToggle(!t,!1),this.checkEditPlace()},setPlainMode:function(e){this.plainMode=e,triggerEvent(window,"scroll")},togglePlainMode:function(e){var t,i=ge("wke_b_mode");(null==e?this.plainMode:e)?((t=this.textarea.value)==this.prevWiki?(show(this.cont),hide(this.textarea),this.setPlainMode(!1),triggerEvent(window,"scroll")):ajax.post("al_pages.php",{act:"convert_wiki",Body:t},{onDone:function(e,t){this.wikiPref=t,this.cont.innerHTML=e,show(this.cont),this.prepareCont(this.cont),hide(this.textarea),this.setPlainMode(!1),this.onPlainToggle&&this.onPlainToggle(this.plainMode,!0)}.bind(this),loader:!0}),this.ttUpdate(i,this.modeBtn[0])):(this.changed?(t=this.val(),this.prevWiki=t,val(this.textarea,t),this.textarea.autosize&&this.textarea.autosize.update()):this.prevWiki=this.textarea.value,hide(this.cont),show(this.textarea),this.setPlainMode(!0),this.ttUpdate(i,this.modeBtn[1])),this.onPlainToggle&&this.onPlainToggle(this.plainMode,!0),window.WkView&&WkView.onResize()},prepareCont:function(e){for(var t=geByTag("blockquote",e),i=t.length;i--;){var r=t[i];if(!r.firstChild||"DIV"!=r.firstChild.tagName){for(var n=document.createDocumentFragment();r.firstChild;)n.appendChild(r.firstChild);var s=ce("div");s.appendChild(n),r.appendChild(s)}}var a=geByClass("wk_photo",e);for(a.push.apply(a,geByClass("wk_photo_no_padding",e)),a.push.apply(a,geByClass("wk_video",e)),a.push.apply(a,geByClass("audio_row",e)),i=a.length;i--;)a[i].setAttribute("contenteditable","false")},plainGetSel:function(){var e,t=0,i=0;if(document.selection){e=!0;var r=document.selection.createRange();if(r&&r.parentElement()==this.textarea){var n=this.textarea.value,s=n.length,a=n.replace(/\r\n/g,"\n"),o=this.textarea.createTextRange();o.moveToBookmark(r.getBookmark());var h=this.textarea.createTextRange();h.collapse(!1),o.compareEndPoints("StartToEnd",h)>-1?t=i=s:(t=-o.moveStart("character",-s),browser.msie&&intval(browser.version)<9&&(t+=a.slice(0,t).split("\n").length-1),o.compareEndPoints("EndToEnd",h)>-1?i=s:(i=-o.moveEnd("character",-s),browser.msie&&intval(browser.version)<9&&(i+=a.slice(0,i).split("\n").length-1)))}}else this.textarea.selectionStart||"0"==this.textarea.selectionStart?(t=this.textarea.selectionStart,i=this.textarea.selectionEnd):i=t=this.textarea.value.length;return[t,i,e]},plainInsert:function(e,t,i){this.textarea.focus(),t=t||"",i=i||{};var r=(e=e||"").length,n=t.length,s=this.plainGetSel(),a=s[0],o=s[1],h=this.textarea.value.substr(0,a),c=this.textarea.value.substr(a,o-a),l=this.textarea.value.substr(o,this.textarea.value.length-o),u=c.match(this.re.endSp);if(u){var d=u[0].length;c=c.substr(0,c.length-d),o-=d,l=u[0]+l}if(i.replace&&(c=""),a>=r&&h.substr(a-r,a)==e&&l.substr(0,n)==t)e="",t="",h=h.substr(0,a-r),l=l.substr(n),a-=r,o-=r;else if(a+=r,o+=r,i.newline){"\n"!=h.substr(-1)&&(h+="\n",a+=1,o+=1);var p=l.substr(0,1);"\n"!=p&&"\r"!=p&&(l="\n"+l)}this.textarea.value=h+e+c+t+l,setTimeout(function(){this.plainFocus(this.textarea,a,o)}.bind(this),0)},wrapHeader:function(e,t){var i=this.getRange(),r=this.getState(i),n=r[0];n.className==e?this.unsurround(n):(2==r[1]&&this.unsurround(n),this.surround(ce("div",{className:e}),t[1])),this.checkEditPlace()},wrapEl:function(e,t,i,r){var n=this.getRange(),s=this.getState(n),a=s[0];a.tagName==e.toUpperCase()?this.unsurround(a):(6==s[1]&&this.unsurround(a),this.surround(ce(e),t[1],i,r)),this.checkEditPlace()},wrapList:function(e,t){var i=this.getRange(),r=this.getState(i),n=r[0];if(5==r[1]&&geByTag("li",n).length){for(var s=n.firstChild,a=document.createDocumentFragment();s;){if("LI"==s.tagName){for(var o=ce("div");s.firstChild;)o.appendChild(s.firstChild);a.appendChild(o)}s=s.nextSibling}var h=a.firstChild,c=a.lastChild;n.parentNode.replaceChild(a,n),this.setSelection(h,c)}else this.surround(ce(e,{className:"listing"}),t[1],'<li><span class="l">',"</span></li>",!0);this.checkEditPlace()},fixHeader:function(e){e.parentNode.replaceChild(ce("div",{className:e.className,innerHTML:clean(this.getText(e))}),e)},fixList:function(e){for(var t=e.firstChild;t;){var i=t;if(t=t.nextSibling,1==i.nodeType&&"SPAN"!=i.tagName||3==i.nodeType){var r=ce("span",{className:"l"});i.parentNode.replaceChild(r,i),r.appendChild(i)}}},showUrlBox:function(e,t){var i;if(this.plainMode)cur.wkBoxRange=this.plainGetSel(),i=this.textarea.value.substr(cur.wkBoxRange[0],cur.wkBoxRange[1]-cur.wkBoxRange[0]);else if(3==e[1]){var r=e[0];if(i=this.getText(r),cur.wkLinkHref=r.getAttribute("href"),cur.wkLinkNote=cur.wkLinkHref.match(this.re.noteHref),cur.wkLinkPage=cur.wkLinkHref.match(this.re.pageWikiHref),cur.wkLinkCustomPage=cur.wkLinkHref.match(this.re.pageHref),cur.wkBoxRange=this.setFocus(r,{noCollapse:!0}),cur.wkLinkEl=r,t)return this.unsurround(r,!0),this.checkEditPlace(),!1}else i=document.getSelection?document.getSelection()+"":document.selection?document.selection.createRange().text+"":"",cur.wkBoxRange=this.getRange();cur.wkLinkName=i,cur.isBLogEditor&&(cur.wkLinkNote=cur.wkLinkPage=cur.wkLinkCustomPage=null);var n=showBox("wiki.php",{act:"link_box_new",note:""|this.note,page:this.page||"",oid:this.oid},{cache:1});n.editor=this,n.setOptions({onHide:function(){cur.wkBoxRange&&this.setSelectionRange(cur.wkBoxRange)}.bind(this)})},showPhotoBox:function(e){var t=geByTag1("IMG",e);if(!t)return!1;var i,r,n=e.getAttribute("href"),s="",a=(n||"").match(this.re.photoHref);if(a)i=a[1],r=(a[2]||"").substr(1);else{var o,h=e.getAttribute("wiki");h&&(a=h.split("_"),i=a[0],r=a[1]),s=n,s=(o=n.match(this.re.away))?decodeURIComponent(o[1]):n}if(!i||!r)return!1;var c=e.getAttribute("title");cur.wkPhotoEditParams={el:t,oid:i,pid:r,text:c||"",url:s,saveRatio:!0},cur.wkSavePhoto=function(n,s,a,o){var h=this.getPhotoHTML(i,r,t.src,n,s,a,o);e.parentNode.replaceChild(se(h),e)}.bind(this),cur.wkBoxRange=this.getRange(),showBox("wiki.php",{act:"photo_box_new"},{cache:1}).setOptions({onHide:function(){cur.wkBoxRange&&this.setSelectionRange(cur.wkBoxRange)}.bind(this)})},getLinkWiki:function(e,t,i){var r,n;"/"==e[0]&&(e="https://vk.com"+e);var s="[",a="]";if(r=e.match(this.re.away))e=decodeURIComponent(r[1]);else if((n=e.match(this.re.pageHref))&&!cur.isBLogEditor){try{e=decodeURIComponent(n[1])}catch(t){e=n[1]}s="[[",a="]]"}else if((n=e.match(this.re.devHref))&&!cur.isBLogEditor){try{e=decodeURIComponent(n[1])}catch(t){e=n[1]}s="[[",a="]]"}else(n=e.match(this.re.pageId))&&!cur.isBLogEditor&&(e=n[1],s="[[",a="]]");var o="";if(i){var h=i.getAttribute("onclick");h&&-1!=h.indexOf("inBox")&&(o+="box|")}return(o||e!=t)&&(o+=t),s+e+(o?"|"+o:"")+a},insertLink:function(e,t,i){if(this.plainMode)return this.plainInsert(this.getLinkWiki(t,e),"",{replace:1}),!1;var r=ce("a",{className:i?"wk_ext_link":"",innerHTML:clean(e),href:t});cur.wkLinkEl&&cur.wkLinkEl.parentNode?cur.wkLinkEl.parentNode.replaceChild(r,cur.wkLinkEl):(cur.wkBoxRange&&this.setSelectionRange(cur.wkBoxRange),this.insert([r],!0)),delete cur.wkLinkRange,delete cur.wkLinkEl,this.changed=!0},checkEditPlace:function(){setTimeout(function(){var e=this.getState(this.getRange());this.switchMode(e[1])}.bind(this),0)},toggleState:function(e){var t=clone(this.state);t[e]=!t[e],"left"==e&&t[e]&&(t.center=0,t.left=0,t.right=0),"right"==e&&t[e]&&(t.center=0),"center"==e&&t[e]&&(t.right=0),this.setState(t)},setState:function(e){this.plainMode&&(e.mode=1);var t=["bold","italic","right","center","url","mode","h1","h2","h3","list","blockquote"];Object.keys(t).forEach(i=>{e[i=t[i]]&&!this.state[i]?addClass(ge("wke_b_"+i),"wke_b_active"):!e[i]&&this.state[i]&&removeClass(ge("wke_b_"+i),"wke_b_active")}),this.state=e},saveLastCursor:function(){var e=this.getRange(!1,!0);e&&(cur.lastCursor=e)},switchMode:function(e){if(this.mode==e)return!1;var t=!1;2==e?t={h1:1,h2:1,h3:1}:3==e?t={url:1}:4==e?t={}:5==e&&(t={bold:1,italic:1,list:1,url:1}),t?Object.keys(this.buttons).forEach(e=>{toggleClass("wke_b_"+e,"wke_b_disabled",!t[e])}):this.mode>=2&&Object.keys(this.buttons).forEach(e=>{removeClass("wke_b_"+e,"wke_b_disabled")});var i=ge("wke_b_url");3==e?(addClass("wke_b_url","wke_b_remove"),i.setAttribute("tooltip",this.buttons.url[1])):3==this.mode&&(removeClass("wke_b_url","wke_b_remove"),this.ttUpdate(i,this.buttons.url[0])),this.mode=e,this.onSwitchMode&&this.onSwitchMode()},getAlign:function(e){return e.style.textAlign||e.getAttribute("align")},getSel:function(){return!!window.getSelection&&window.getSelection()},getRangeCont:function(e){return null==e?null:e.commonAncestorContainer?e.commonAncestorContainer:e.parentElement?e.parentElement():e.item(0)},getRange:function(e,t){var i,r=!e&&this.getSel();if(r&&r.rangeCount){i=r.getRangeAt(0);for(var n=this.getRangeCont(i);n;){if(n==this.cont)return i;n=n.parentNode}}return!t&&(document.createRange?(i=document.createRange()).selectNodeContents(this.cont):(i=document.body.createTextRange()).moveToElementText(this.cont),i.collapse(!1),i)},unsurround:function(e,t){for(var i=document.createDocumentFragment(),r=e.firstChild,n=e.lastChild;e.firstChild;)i.appendChild(e.firstChild);return e.parentNode.replaceChild(i,e),t||this.setSelection(r,n),this.getState(),!1},getRangeText:function(e,t){if(browser.msie)return document.selection.createRange().text;if(t&&e.cloneContents){var i=e.cloneContents();return this.getText(i,!0)}return e+""},surround:function(e,t,i,r,n){var s=this.getRange(),a=this.getRangeText(s,n);if(i=i||"",r=r||"",s.collapsed||!a)t&&(e.innerHTML=i+(t||"header")+r);else{var o="";n?(a=a.split("\n"),Object.keys(a).forEach(e=>{a[e]&&(o+=i+clean(a[e])+r)}),o||(o=i+(t||"header")+r)):o=i+clean(a||"")+r,e.innerHTML=o}this.replaceSelected([e])&&(this.cleanContent(this.getRangeCont(s)),this.setFocus(e,{noCollapse:!0}))},cleanContent:function(e){if(1==e.nodeType){var t=[];t.push.apply(t,geByClass("wk_header",e)),t.push.apply(t,geByClass("wk_sub_header",e)),t.push.apply(t,geByClass("wk_sub_sub_header",e)),Object.keys(t).forEach(e=>{""===this.getText(t[e])&&re(t[e])})}},isLink:function(e){return"A"==e.tagName&&!hasClass(e,"wk_photo")&&!hasClass(e,"wk_photo_no_padding")},isPhoto:function(e){for(;e&&e!=this.cont;){if(this.isPhotoEl(e))return e;e=e.parentNode}return!1},isPhotoEl:function(e){return hasClass(e,"wk_photo")||hasClass(e,"wk_photo_no_padding")||hasClass(e,"wikiPhoto")},isVideo:function(e){return hasClass(e,"wk_video")},isAudio:function(e){return hasClass(e,"audio_row")},getState:function(e){var t,i,r=this.getRangeCont(e);e&&(t=e.startContainer,i=e.endContainer);for(var n=!1,s=0,a=t,o={};a;){(t&&a==r||a==i)&&(t=!1,a=i);var h=a.tagName;if(1==a.nodeType){switch(h){case"B":case"STRONG":o.bold=1;break;case"I":case"EM":o.italic=1;break;case"PRE":o.pre=1}this.testRight(a)&&(o.right=1),this.testCenter(a)&&(o.center=1)}if("LI"==h&&this.fixList(a),!s){var c=void 0;a.className&&(c=a.className.match(this.re.header)),c?(c[2]?o.h3=1:c[1]?o.h2=1:c[0]&&(o.h1=1),n=a,s=2,(o.right||o.center)&&this.fixHeader(a)):this.isLink(a)?(n=a,s=3):"PRE"==h?(n=a,s=4):"UL"==h||"OL"==h?(n=a,s=5,o.list=1):"BLOCKQUOTE"==h&&(n=a,s=6,o.blockquote=1)}if(a==this.cont)break;a=a.parentNode}return this.setState(o),[n,s]},replaceSelected:function(e){this.checkFocus();var t=this.getRange();if(t.deleteContents&&!browser.msie){if(t.deleteContents(),browser.opera){document.execCommand("insertHTML",!1,'<span id="wke_tmp_el"></span>');var i=ge("wke_tmp_el");Object.keys(e).forEach(t=>{i.parentNode.insertBefore(e[t],i)}),re(i)}else Object.keys(e).forEach(i=>{t.insertNode(e[i])});return!0}var r=document.selection.createRange(),n="";return Object.keys(e).forEach(t=>{n+=e[t].outerHTML}),r.pasteHTML(n),r.collapse(!1),r.select(),!1},insert:function(e,t,i){if(this.replaceSelected(e)){var r=e[0];if(t||r.previousSibling&&"BR"==r.previousSibling.nodeName||r.parentNode.insertBefore(ce("br"),r),!(r=e[e.length-1]).nextSibling||"BR"!=r.nextSibling.nodeName&&1==r.nodeType&&(!r.nextSibling.data||!r.nextSibling.data.match(this.re.letter))){var n=ce("br");r.parentNode.appendChild(n)}i?this.setFocus(r):this.setFocus(r.nextSibling)}},editable:function(e){return e&&3!=e.nodeType&&e.getAttribute&&"true"==e.getAttribute("contenteditable")},setSelection:function(e,t){var i=this.getRange();i.setStartBefore(e),i.setEndAfter(t),this.setSelectionRange(i)},plainFocus:function(e,t,i){if(browser.msie&&document.selection){for(var r=e.value,n=t,s=0;s<n;s++)"\r"==r[s]&&(t-=1,i-=1);for(n=i;s<n;s++)"\r"==r[s]&&(i-=1)}elfocus(e,t,i)},setSelectionRange:function(e){if(this.plainMode)this.plainFocus(this.textarea,e[0],e[1]);else{var t=this.getSel();t.removeAllRanges(),t.addRange(e)}},setFocus:function(e,t){var i=this.getSel(),r=this.getRange();if(t||(t={}),i)i.removeAllRanges(),cur.lastCursor?(r=cur.lastCursor).collapse(!1):(null!=t.offset?(r.setStart(e,0),r.setEnd(e,0)):r.selectNodeContents(e),t.noCollapse||r.collapse(t.toStart||!1)),i.addRange(r);else if(r=document.body.createTextRange(),3!=e.nodeType)try{r.moveToElementText(e),t.noCollapse||r.collapse(t.toStart||!1),r.select()}catch(e){}return r},insertAudio:function(e,t,i,r,n,s,a){if(this.abox.hide(),this.plainMode)return this.plainInsert("[[audio"+r+"]]","",{replace:1}),!1;a=geByClass1("_audio_row",domPN(a));var o=AudioUtils.getAudioFromEl(a),h=AudioUtils.drawAudio(o),c=se(h);c.setAttribute("contenteditable","false"),this.insert([c])},insertVideo:function(e,t,i,r,n){return this.vbox.hide(),this.plainMode?(this.plainInsert("[[video"+n+"]]","",{replace:1}),!1):(this.getImgSize(e,function(i,s){if(i>this.imgWidth+20){var a=this.imgWidth/i;i=this.imgWidth,s=Math.floor(s*a)}if(s>this.imgWidth+20){var o=this.imgWidth/s;s=this.imgWidth,i=Math.floor(i*o)}var h=se('<a class="wk_video" href="'+r+'" contentEditable="false" onclick="return showVideo(\''+n+"', '', {autoplay: 1}, event)\"><img alt=\""+t+'" title="'+t+'" src="/images/play_video_wide.png?3" style="background-image: url('+e+');">');this.insert([h])}.bind(this)),!1)},getPhotoHTML:function(e,t,i,r,n,s,a){var o,h="width: "+r+"px; height: "+n+"px;";s?o="return goAway('"+(s=clean(s))+"')":(s="/photo"+e+"_"+t,o="return "+this.inst+".editPhoto(this);");var c="";return a&&(c=' title="'+clean(a)+'"'),'<a contenteditable="false"'+c+' class="wk_photo" wiki="'+e+"_"+t+'" href="'+s+'" onclick="'+o+'"><img src="'+i+'" style="'+h+'" /></a>'},insertPhoto:function(e,t,i,r){return this.pbox.showProgress(),this.getImgSize(r,function(i,n){if(this.pbox.hide(),i>this.imgWidth+20){var s=this.imgWidth/i;i=this.imgWidth,n=Math.floor(n*s)}if(n>this.imgWidth+20){var a=this.imgWidth/n;n=this.imgWidth,i=Math.floor(i*a)}if(this.plainMode)return this.plainInsert("[[photo"+e+"_"+t+"|"+i+"x"+n+"px;noborder| ]]","",{replace:1}),!1;this.insert([ce("div",{align:"center",innerHTML:this.getPhotoHTML(e,t,r,i,n)})])}.bind(this)),!1},getImgSize:function(e,t){var i=ce("img",{src:e});i.onload=function(){var e=getSize(i);t(e[0],e[1]),re(i)},this.loader.appendChild(i)},editPhoto:function(){return!1},ttOver:function(e,t){if(hasClass(e,"wke_b_disabled"))return!1;Object(n.showTooltip)(e,{text:function(){return e.getAttribute("tooltip")},shift:[0,8,8],asrtl:t,className:"wke_tt"+(t?" wke_tt_right":""),black:1})},ttUpdate:function(e,t){e.setAttribute("tooltip",t),e.tt&&(e.tt.show&&e.tt.show(),window.tooltips&&tooltips.rePositionTT(e.tt))},isCont:function(e){if(!e)return!1;var t=e.nodeName;return!("DIV"!=t&&"TABLE"!=t&&"UL"!=t&&"OL"!=t&&"PRE"!=t&&"BLOCKQUOTE"!=t&&!this.editable(e))},inBold:function(e){for(;e;){var t=e.nodeName;if("B"==t||"STRONG"==t)return!0;if(e==this.cont)return!1;e=e.parentNode}return!1},inItalic:function(e){for(;e;){var t=e.nodeName;if("I"==t||"EM"==t)return!0;if(e==this.cont)return!1;e=e.parentNode}return!1},cleanPrep:function(e){return e.replace(this.re.notWords,"")},lastNode:function(e){for(var t=e.lastChild;t&&3==t.nodeType&&""==trim(t.nodeValue);)t=t.previousSibling;return t},prevNode:function(e){for(var t=e.previousSibling;t&&3==t.nodeType&&""==trim(t.nodeValue);)t=t.previousSibling;return t},getWikiHref:function(e){var t=e.getAttribute("href"),i=t.match(this.re.pageId);return i?i[1]:t},getPhotoOpts:function(e,t){t||(t=[]),hasClass(e,"wk_photo_right")&&t.unshift("right"),hasClass(e,"wk_photo_left")&&t.unshift("left"),hasClass(e,"wk_photo_center")&&t.unshift("center");var i="IMG"==e.tagName?e:geByTag1("img",e),r=getSize(i);return t.unshift(r[0]+"x"+r[1]+"px"),t.join(";")},getElementWiki:function(e,t){var i="",r="",n=!1,s=e.nodeName;"TD"!=s&&"TH"!=s||(t|=1),"PRE"==s&&(t|=2),"LI"==s&&(t|=3);var a,o,h,c=this.getContent(e,t);switch(s){case"P":c=c.replace(this.re.trimSp,""),(h=e.previousSibling)&&!this.isCont(h)&&"BR"!=h.nodeName&&(i="\n"),c?this.testLeft(e)?(i="<left>",r="</left>\n"):this.testRight(e)?(i="<right>",r="</right>\n"):this.testCenter(e)&&(i="<center>",r="</center>\n"):n="\n";break;case"DIV":c=c.replace(this.re.trimSp,"");var l,u=e.className.match(this.re.header);if(u)n=(l=u[2]?"====":u[1]?"===":"==")+this.getText(e).replace("\n","")+l+"\n";else if(hasClass(e,"audio_row")){var d=e.getAttribute("data-full-id");d&&(n="[[audio"+d+"]]")}else{if(""==c)break;if("\n"!=c.substr(-1)){var p=this.lastNode(e);p&&"PRE"==p.tagName||(r="\n")}var g=this.prevNode(e);g&&!this.isCont(g)&&"BR"!=g.tagName&&(i="\n"),c?this.testLeft(e)?(i+="<left>",r="</left>\n"):this.testRight(e)?(i+="<right>",r="</right>\n"):this.testCenter(e)&&(i+="<center>",r="</center>\n"):r="\n"}break;case"CENTER":"\n"!=(c=c.replace(this.re.trimSp,"")).substr(-1)&&(r="\n"),i+="<center>",r="</center>"+r;break;case"BR":r="\n",1&t&&!cur.isBLogEditor?r+="<br/>":3&t&&(r="<br/>"+r);break;case"B":case"STRONG":a=c.split("\n"),o=[];var f=this.inBold(e.parentNode);Object.keys(a).forEach(e=>{var t=a[e];"=="!=t.substr(0,2)&&t.match(this.re.letter)&&!f?o.push(`'''${t}'''`):o.push(t)}),n=o.join("\n");break;case"I":case"EM":a=c.split("\n"),o=[];var b=this.inItalic(e.parentNode);Object.keys(a).forEach(e=>{var t=a[e];"=="!=t.substr(0,2)&&t.match(this.re.letter)&&!b?o.push(`''${t}''`):o.push(t)}),n=o.join("\n");break;case"IMG":if(this.isPhotoEl(e)){var k=this.cleanPrep(e.getAttribute("title")||" "),w=e.getAttribute("wiki");w&&(n="[[photo"+(w=w.split("_"))[0]+"_"+(w[1]||"")+"|"+this.getPhotoOpts(e,["nolink"])+"|"+k+"]]")}break;case"A":if(this.isPhotoEl(e)){var v=e.href.match(this.re.photoHref),m=this.cleanPrep(e.getAttribute("title")||" ");if(v)n="[[photo"+v[1]+(v[2]||"")+"|"+this.getPhotoOpts(e)+"|"+m+"]]";else{var _=e.getAttribute("wiki");_&&(n="[[photo"+(_=_.split("_"))[0]+"_"+(_[1]||"")+"|"+this.getPhotoOpts(e)+"|"+this.getWikiHref(e)+"]]")}}else if(hasClass(e,"wk_video")){var x=e.href.match(this.re.videoHref);x&&(n="[[video"+x[1]+(x[2]||"")+"]]")}else{var C=e.getAttribute("href");if(!C)break;var y=C.match(this.re.noteHref);if(y){n="[[note"+y[1]+"_"+y[2]+"|"+this.getText(e)+"]]";break}var E=C.match(this.re.pageWikiHref);if(E){n="[[page"+E[1]+"_"+E[2]+"|"+this.getText(e)+"]]";break}var S=C.match(this.re.topicHref);if(S){n="[[topic"+S[1]+"_"+S[2]+"|"+this.getText(e)+"]]";break}var R=C.match(this.re.photoHref);if(R){var T=geByTag1("img",e);if(T){cur.ii=T;var B=this.cleanPrep(e.getAttribute("title")||" ");n="[[photo"+R[1]+(R[2]||"")+"|"+this.getPhotoOpts(e)+"|"+B+"]]";break}}n=this.getLinkWiki(C,this.getText(e),e)}break;case"PRE":var N=this.getText(e);n="<pre>"+(N=N.replace(this.re.n,"\r\n"))+"</pre>";break;case"BLOCKQUOTE":i="<blockquote>";var P=(c=c.replace(this.re.trimSp,"")).substr(0,1);"*"!=P&&"#"!=P||(i+="\n"),r="</blockquote>"+r;break;case"CODE":c=c.replace(this.re.trimSp,""),i="<code>",r="</code>";break;case"UL":case"OL":c=c.replace(this.re.trimSp,""),(h=this.prevNode(e))&&!this.isCont(h)&&"BR"!=h.nodeName&&(i="\n");break;case"LI":var L=c.substr(0,1);if("*"!=L&&"#"!=L){var M=e.parentNode;for(i="* ";M&&M!=this.cont;){if("OL"==M.tagName){i="# ";break}if("Ul"==M.tagName)break;M=M.parentNode}}r="\n",c=c.split("\n");var O="";Object.keys(c).forEach(e=>{var t=c[e].match(this.re.wikiLi);t?O+=(e>0?"\n":"")+t[1]+c[e]:c[e]?O+=(e>0?"\n:":"")+c[e]:O+="<br/><br/>"}),c=O;break;case"DD":c=c.replace(this.re.trimSp,""),i=":";break;case"SPAN":hasClass(e,"wk_gray")&&(i="<gray>",r="</gray>");break;case"U":i="<u>",r="</u>";break;case"S":case"STRIKE":i="<s>",r="</s>";break;case"SUB":i="<sub>",r="</sub>";break;case"SUP":i="<sup>",r="</sup>";break;case"TABLE":i="{|";var A=[];hasClass(e,"wk_table_no_border")&&A.push("noborder"),hasClass(e,"wk_table_no_margin")&&A.push("nomargin");var H=geByTag1("td",e);hasClass(H,"wk_cell_no_padding")&&A.push("nopadding"),A.length&&(i+=A.join(";"));for(var I=e.firstChild,j=[];I;){var W=I.tagName;if("COLGROUP"!=W){if("COL"==W){var U=I.getAttribute("style").match(this.re.colWidth);U&&j.push(intval(U[1]))}I=I.nextSibling}else I=I.firstChild}j.length&&(i+="\n|~ "+j.join(" ")),r="|}";break;case"TR":i="|-\n";break;case"TD":case"TH":i="TH"==s?"! ":"| ","\n"!=(c=c.replace(this.re.trimSp,"")).substr(-1)&&(r="\n"),c=c.replace(this.re.nn,"<br/>")}return n||i+this.getWikiBreak(i,c)+c+this.getWikiBreak(c,r)+r},strToWiki:function(e){return e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(this.re.trimN," ")).replace(this.re.n," ")).replace(this.re.sp," ")).replace(/^#/g,"&#35;").replace(/^\*/g,"&#42;")).replace(/</g,"&#60;").replace(/>/g,"&#62;")).replace(/\[/g,"&#91;").replace(/]/g,"&#93;")).replace(/\{/g,"&#123;").replace(/\}/g,"&#125;")).replace(/==/g,"&#61;&#61;").replace(/~/g,"&#126;")).replace(/\|/g,"&#124;").replace(/!/g,"&#33;")},getContent:function(e,t){for(var i,r=e.firstChild,n="";r;){switch(r.nodeType){case 3:i=this.strToWiki(r.data),"\n"==n.substr(-1)&&(i=i.replace(this.re.startSp,"")),n+=i;break;case 1:i=this.getElementWiki(r,t||0),n+=this.getWikiBreak(n,i)+i}r=r.nextSibling}return n},getWikiBreak:function(e,t){if(e&&"\n"!=e.substr(-1)){var i=t.substr(0,2);if("=="==i||"|-"==i||"|}"==i||"{|"==i)return"\n";if("|}"==e.substr(-2)&&"\n"==t)return"\n"}return""},getText:function(e,t){if(!e)return"";if(t){for(var i=e.firstChild,r="";i;){switch(i.nodeType){case 3:r+=i.data.replace(this.re.n," ").replace(this.re.sp," ");break;case 1:var n=i.tagName;"DIV"!=n&&"P"!=n&&"PRE"!=n&&"BLOCKQUOTE"!=n&&"CENTER"!=n&&"RIGHT"!=n&&"LEFT"!=n&&"BR"!=n||(r+="\n"),r+="B"==n||"STRONG"==n?"<b>"+this.getText(i,!0)+"</b>":"I"==n||"EM"==n?"<i>"+this.getText(i,!0)+"</i>":this.getText(i,!0)}i=i.nextSibling}return r}return e.innerText?e.innerText:e.textContent?e.textContent:""},testLeft:function(e){return"left"==e.getAttribute("align")||"left"==e.style.textAlign},testCenter:function(e){return"center"==e.getAttribute("align")||"center"==e.style.textAlign},testRight:function(e){return!("right"!=e.getAttribute("align")&&"right"!=e.style.textAlign&&(!hasClass(e,"wk_right")||e.style.textAlign))},showLengthMsg:function(){this.lengthMsg||setTimeout(Object(r.showFastBox)({title:getLang("global_error")},this.lang.too_long||"text too long",getLang("global_close")).hide,2e3)},onChangeHandler:function(){this.changed=!0,this.onChange&&this.onChange()},val:function(){var e;if(this.plainMode)e=this.textarea.value;else{if(!this.cont)return!1;e=(e=this.getContent(this.cont,0)).replace(this.re.lineBr,(function(e){for(var t=e.length-2,i="";t--;)i+="<br/>";return"\n"+i+"\n"})),this.wikiPref&&(e=this.wikiPref+e)}return e.length>19e3?(this.showLengthMsg(),!1):(this.textarea.value=e,e)},re:{n:new RegExp("\n","g"),nn:new RegExp("\n\n","g"),sp:new RegExp("[ ]+","g"),endSp:new RegExp("[  ]+$"),startSp:new RegExp("^[  ]+"),trimSp:new RegExp("^ | $","g"),trimN:new RegExp("^\n|\n$","g"),letter:new RegExp("[^\\s\n]"),photoHref:new RegExp("photo([-0-9]+)(_[-0-9]+)?"),videoHref:new RegExp("video([-0-9]+)(_[-0-9]+)?"),lineBr:new RegExp("\n([\n]+)\n","g"),header:new RegExp("wk(_sub)?(_sub)?_header"),noteHref:new RegExp("^/?note([0-9]+)_([0-9]+)"),topicHref:new RegExp("^/?topic([-0-9]+)_([0-9]+)"),pageWikiHref:new RegExp("^/?page([-0-9]+)_([0-9]+)"),away:new RegExp("/away\\.php\\?to=([^&]+)"),pageHref:new RegExp("(?:[/|.]vk.com|^)/(?:pages|developers)?(?:.*&)?p=([^&]+)"),devHref:new RegExp("(?:[/|.]vk.com|^)/dev/([^?#]+)"),pageId:new RegExp("[/|.]vk.com/(page[-0-9]+_[-0-9]+)"),audio:new RegExp("audio([-0-9]+)_([-0-9]+)(_[0-9]+)?"),wikiLi:new RegExp("^([*#])"),notWords:new RegExp("([\\[\\]\\(\\)\\|\\/'\"\\*<>]+)","g"),colWidth:new RegExp("width: ([0-9]+)%")}}),window.WkEditor=h;try{window.stManager.done(window.jsc("web/wk_editor.js"))}catch(e){}}});